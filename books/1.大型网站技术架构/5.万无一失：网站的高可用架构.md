### 5. 网站的高可用架构
#### 5.1 网站高可用架构的度量与考核
- 度量：
  - 基本高可用：99%,年故障时间小于88小时；
  - 较高高可用：99.9%,年故障时间小于9小时；
  - 具有自动恢复功能的高可用：99.99%，年故障时间小于53分钟；
  - 极高高可用：5个9，99.999%，年故障时间小于5分钟；
- 考核：
  - 将网站故障分类，分级别，制定故障处理流程，完成故障处理后记录考核；
#### 5.2 高可用的网站架构
- 实现高可用架构的主要手段数是据和服务的冗余备份及失效转移；
- 一般按分层包括应用层高可用、服务层高可用、数据层高可用；
#### 5.3 高可用的应用
- 通过负载均衡进行无状态服务的失效转移
- 应用服务器集群的 Session 管理
  - Session 复制：应用之间互相同步Sesion,设计简单，本机读取Session快，但占用网络资源，系统不堪重负；
  - Session 绑定：根据IP的Hash算法把用户一次回话与一台服务器绑定，称作会话粘滞，此方式失去高可用性，服务宕机Session将不复存在；
  - Cookie 记录 Session：使用Cookie记录Session 影响性能，安全性低；
  - Session 服务器：应用层分为无状态的应用服务器和有状态的Session服务器，用独立的服务器记录Session;
 #### 5.4 高可用的服务
- 分级管理：核心应用使用较好的硬件且在部署上隔离；
- 超时设置：宕机、死锁等导致服务失去响应，设置超时有助于调用方重试或选择请求转移；
- 异步调用：根据业务场景使用消息，提高效率和高可用；
- 服务降级：流量高峰期，拒绝部分用户请求或关闭不要的服务保障核心服务正常；
- 幂等性设计：消息重复消费时，要做好验证，不要产生异常数据；
#### 5.5 高可用的数据
- CAP 原理
  - 数据一致性（C）、数据可用性（A）、分区容错性（P）；
  - 一致性和可用性是矛盾的，具体看业务要求抉择；
- 数据备份
  - 冷备：优点简单廉价，缺点不能保证数据最终一致性；
  - 热备：分为异步热备和同步热备;
- 失效转移
  - 三个步骤：失效确认、访问转移、数据恢复；
#### 5.6 高可用网站的软件质量保证
- 网站发布
  - 自动化测试
  - 预发布校验
  - 代码版本控制
  - 自动化发布
  - 灰度发布
#### 5.7 网站运行监控
一般“不允许没有监控的系统上线”，没有监控就好比飞机没有仪表盘、盲人骑瞎马、半夜临深渊而不知；
- 监控数据采集
  - 用户行为日志收集：运营数据收集、服务器日志、客户端浏览器日志;
- 监控管理
  - 系统报警
  - 失效转移
  - 自动优雅降级